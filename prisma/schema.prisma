generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OfferStatus {
  PENDING
  COUNTERED
  ACCEPTED
  CANCELLED
  DECLINED
  EXPIRED
}

enum ReportTargetType {
  USER
  LISTING
  MESSAGE
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  passwordHash  String?
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  profile       Profile?
  listings      Listing[]
  sentMessages  Message[] @relation("MessageSender")
  buyerConversations Conversation[] @relation("ConversationBuyer")
  sellerConversations Conversation[] @relation("ConversationSeller")
  buyerOffers   Offer[] @relation("BuyerOffers")
  sellerOffers  Offer[] @relation("SellerOffers")
  reports       Report[] @relation("Reporter")
  blockedBy     Block[] @relation("Blocked")
  blocking      Block[] @relation("Blocker")
  revealEvents  ContactRevealEvent[]
}

model Profile {
  id               String   @id @default(cuid())
  userId           String   @unique
  username         String   @unique
  bio              String?
  phone            String?
  emailPublic      String?
  city             String?
  isVerifiedSeller Boolean  @default(false)
  responseRate     Int      @default(100)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Listing {
  id            String   @id @default(cuid())
  sellerId      String
  title         String
  description   String
  category      String
  priceCents    Int
  location      String
  isSold        Boolean  @default(false)
  isReserved    Boolean  @default(false)
  reservedUntil DateTime?
  viewsCount    Int      @default(0)
  likesCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  seller        User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  images        ListingImage[]
  conversations Conversation[]
  offers        Offer[]
  reports       Report[]
  revealEvents  ContactRevealEvent[]
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  url       String
  sortOrder Int      @default(0)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Conversation {
  id         String   @id @default(cuid())
  listingId  String
  buyerId    String
  sellerId   String
  isClosed   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer      User     @relation("ConversationBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller     User     @relation("ConversationSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  messages   Message[]
  offers     Offer[]

  @@unique([listingId, buyerId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  reports        Report[]
}

model Offer {
  id             String      @id @default(cuid())
  listingId       String
  conversationId  String
  buyerId         String
  sellerId        String
  amountCents     Int
  status          OfferStatus @default(PENDING)
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  listing         Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  buyer           User        @relation("BuyerOffers", fields: [buyerId], references: [id], onDelete: Cascade)
  seller          User        @relation("SellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)
  events          OfferEvent[]

  @@index([listingId, buyerId, status])
}

model OfferEvent {
  id        String   @id @default(cuid())
  offerId    String
  actorId    String
  type       String
  note       String?
  createdAt  DateTime @default(now())
  offer      Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
}

model ContactRevealEvent {
  id         String   @id @default(cuid())
  listingId   String
  viewerId    String
  sellerId    String
  field       String
  createdAt   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewer      User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)
}

model Report {
  id          String           @id @default(cuid())
  reporterId  String
  targetType  ReportTargetType
  targetId    String
  reason      String
  createdAt   DateTime @default(now())
  listingId   String?
  messageId   String?
  reporter    User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  listing     Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)
  message     Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)
}

model Block {
  id          String   @id @default(cuid())
  blockerId   String
  blockedId   String
  reason      String?
  createdAt   DateTime @default(now())
  blocker     User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked     User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
}
